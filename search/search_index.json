{"config":{"lang":["fr"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Accueil","text":"<p>Cet espace regroupe la documentation de certains de mes projets entre \u00e9lectronique, informatique, impression 3D ou tout autre bricolage en tout genre. Cette documentation prend la suite du blog initi\u00e9 il y a quelques ann\u00e9es... que je n'avais plus pris le temps de mettre \u00e0 jour. Ce nouveau site est (sera) plutot un journal de mes diff\u00e9rentes exp\u00e9rimentations. Il me sert personnellement de \"m\u00e9moire\" et j'esp\u00e8re qu'il pourra \u00eatre utile \u00e0 d'autres.</p> <p>Le premier projet document\u00e9 ici est la cr\u00e9ation d'une solution audio dite \"multiroom\".</p>"},{"location":"multiroom/design/","title":"Description de la solution","text":""},{"location":"multiroom/design/#conception-generale","title":"Conception g\u00e9n\u00e9rale","text":""},{"location":"multiroom/design/#presentation","title":"Pr\u00e9sentation","text":"<p>La solution g\u00e9n\u00e9rale est d\u00e9crite dans la figure suivante.</p> <p></p>"},{"location":"multiroom/design/#serveur-audio-principal-multiroom","title":"Serveur audio principal Multiroom","text":"<p>Ce serveur est le coeur du syst\u00e8me. Il s'agit d'un Raspberry 3 avec une carte DAC Hifiberry Digi+. </p> <p>Il capable d'utiliser plusieurs sources dont :</p> <ul> <li>Spotify</li> <li>appareil Bluetooth</li> <li>fichiers locaux (ou r\u00e9seau accessible depuis le Pi)</li> </ul> <p>Les composants logiciels suivants sont install\u00e9s :</p> <ul> <li>Pi OS Bookworm Lite 32 bits*</li> <li>Snapserver : serveur de diffusion multiroom</li> <li>Snapclient : client multiroom</li> <li>Mopidy : serveur audio</li> <li>Bluetooth ALSA : gestion de l'audio bluetooth</li> </ul> <p>La carte DAC a une sortie audio num\u00e9rique qui est connect\u00e9e \u00e0 un amplificateur audio HiFi.</p>"},{"location":"multiroom/design/#client-multiroom-lite","title":"Client Multiroom \"lite\"","text":"<p>Il s'agit d'un Raspberry Pi Z\u00e9ro W avec un Shim DAC Audio Pimoroni.</p> <p>Les composants logiciels suivants sont install\u00e9s :</p> <ul> <li>Pi OS Bookworm Lite 32 bits*</li> <li>Snapclient : client multiroom</li> </ul> <p>Il est connect\u00e9 \u00e0 une paire d'enceinte amplifi\u00e9es au travers de la prise \"line out\" du DAC.</p>"},{"location":"multiroom/design/#client-multiroom-autonome","title":"Client Multiroom autonome","text":"<p>Il s'agit d'un Raspberry Pi Z\u00e9ro W avec un amplificateur 35W Raspberry Pi DigiAMP+ avec une paire d'enceinte directement connect\u00e9es \u00e0 la sortie de l'amplificateur DigiAmp+.</p> <p>Les composants logiciels suivants sont install\u00e9s :</p> <ul> <li>Pi OS Bookworm Lite 32 bits*</li> <li>Snapclient : client multiroom</li> </ul>"},{"location":"multiroom/design/#pulse-audio-vs-bleutooth-alsa","title":"Pulse Audio vs Bleutooth ALSA","text":"<p>From Debian documentation</p> <p>In short: To connect to a given device, you need Bluetooth hardware on your PC (either built-in, or in the form of a USB dongle), the Bluez daemon, and a compatible audio server (either PulseAudio or PipeWire). Alternatively Bluetooth ALSA available since Debian 12 bookworm allows to avoid running of a high-level sound server.</p> <p>La solution propos\u00e9e ici s'appuie sur Bluetooth Alsa.</p>"},{"location":"multiroom/references/","title":"R\u00e9f\u00e9rences et liens","text":""},{"location":"multiroom/references/#materiel","title":"Mat\u00e9riel","text":"<ul> <li>Audio DAC SHIM (Line-Out)</li> <li>DAC Hifiberry Digi+</li> <li>Raspberry Pi DigiAMP+</li> </ul> <p>Documentation mat\u00e9riel</p> <ul> <li>Config Hifi Berry</li> </ul>"},{"location":"multiroom/references/#logiciels","title":"Logiciels","text":"<ul> <li>Mopidy</li> <li>LMS</li> <li>MPD Website</li> <li>MPD Client</li> <li>Shairport Sync (Airplay)</li> <li>gstream</li> </ul>"},{"location":"multiroom/references/#scripts-outils","title":"Scripts &amp; outils","text":"<ul> <li>How to turn your Raspberry Pi Zero W into a Bluetooth audio receiver</li> <li>Setting up a Bluetooth Speaker from the command line on a raspberry Pi Zero W</li> <li>Raspberry Pi Audio Receiver</li> <li>Headless A2DP Audio Streaming on Raspbian Stretch</li> <li>PiZero-Bluetooth-Audio-Receiver</li> <li>bt-speaker</li> <li>snapclient pour ESP32</li> </ul>"},{"location":"multiroom/references/#quelques-articles","title":"Quelques articles","text":"<ul> <li>MagPi | Make a Raspberry Pi audio player with Mopidy Music</li> <li>MagPi | Build a multi-room audio system with Raspberry Pi</li> <li>Debian | BluetoothUser a2dp</li> <li>Debian | Bluetooth ALSA</li> <li>Page Fault | Building a Bluetooth DAC with Raspberry Pi Zero W</li> <li>Elt 14 | PI Zero W Bluetooth Receiver</li> <li>D-Bus and Bluez</li> <li>Projet Multiroom (fr)</li> <li>snapclient pour Arduino</li> <li>Redirect A2DP sink</li> </ul>"},{"location":"multiroom/todo/","title":"Reste \u00e0 faire","text":""},{"location":"multiroom/todo/#autorisation-bluetooth","title":"Autorisation Bluetooth","text":"<p>Pour le moment, \u00e0 chaque connexion, une autorisation est n\u00e9cessaire</p> <pre><code>pi@multiroom1:~ $ bluetoothctl\nAgent registered\n[CHG] Controller B8:27:EB:5C:D0:BF Pairable: yes\n[CHG] Device 74:B5:87:92:0D:35 Connected: yes\nAuthorize service\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): [CHG] Device 74:B5:87:92:0D:35 UUIDs: 00000000-deca-fade-deca-deafdecacafe\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): [CHG] Device 74:B5:87:92:0D:35 UUIDs: 00001000-0000-1000-8000-00805f9b34fb\n...\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): [CHG] Device 74:B5:87:92:0D:35 UUIDs: 0000180f-0000-1000-8000-00805f9b34fb\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): [CHG] Device 74:B5:87:92:0D:35 UUIDs: 02030302-1d19-415f-86f2-22a2106a0a77\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): [CHG] Device 74:B5:87:92:0D:35 UUIDs: 1ff31936-572e-4b36-a2bf-b2409b1aa6f4\n...\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): [CHG] Device 74:B5:87:92:0D:35 UUIDs: 9fa480e0-4967-4542-9390-d343dc5d04ae\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): [CHG] Device 74:B5:87:92:0D:35 UUIDs: d0611e78-bbb4-4591-a5f8-487910ae4366\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): [NEW] Primary Service (Handle 0xb64c)\n        /org/bluez/hci0/dev_74_B5_87_92_0D_35/service0006\n        00001801-0000-1000-8000-00805f9b34fb\n        Generic Attribute Profile\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): [NEW] Characteristic (Handle 0x006c)\n        /org/bluez/hci0/dev_74_B5_87_92_0D_35/service0006/char0007\n        00002a05-0000-1000-8000-00805f9b34fb\n        Service Changed\n...\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): [NEW] Descriptor (Handle 0xe4fc)\n        /org/bluez/hci0/dev_74_B5_87_92_0D_35/service002d/char0036/desc0038\n        00002900-0000-1000-8000-00805f9b34fb\n        Characteristic Extended Properties\n[agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): yes\nAuthorize service\n[agent] Authorize service 0000110e-0000-1000-8000-00805f9b34fb (yes/no): yes\n</code></pre>"},{"location":"multiroom/todo/#onoff-shim","title":"OnOff Shim","text":"<p>A documenter</p>"},{"location":"multiroom/install/10_install_pi_hifiberry/","title":"Serveur principal","text":""},{"location":"multiroom/install/10_install_pi_hifiberry/#role","title":"R\u00f4le","text":"<p>Ce serveur servira</p> <ul> <li>de serveur Snapcast pour le multiroom</li> <li>de serveur Mopidy pour Spotify ou des fichiers locaux typiquement</li> <li>de r\u00e9cepteur bluetooth</li> </ul>"},{"location":"multiroom/install/10_install_pi_hifiberry/#prerequis","title":"Pr\u00e9requis","text":"<ul> <li>Rasperry PI 3B+</li> <li>Raspberry Pi OS : Bookworm Lite</li> <li>Hat Hifiberry Digi+</li> </ul>"},{"location":"multiroom/install/10_install_pi_hifiberry/#packages","title":"Packages","text":"<pre><code>sudo apt install bluez-alsa-utils\n</code></pre> <p>N\u00e9cessaire pour l'audio BlueTooth</p>"},{"location":"multiroom/install/10_install_pi_hifiberry/#configuration-systeme","title":"Configuration syst\u00e8me","text":"/boot/firmware/config.txt<pre><code>#dtparam=audio=on\ndtoverlay=vc4-kms-v3d,noaudio\ndtoverlay=hifiberry-digi\n</code></pre> <p>Inutile de d\u00e9sactiver l'audio via HDMI. IL peut \u00eatre utile.</p>"},{"location":"multiroom/install/10_install_pi_hifiberry/#installation-snapserver-snapclient","title":"Installation Snapserver &amp; Snapclient","text":"<pre><code>sudo apt install snapserver\nwget https://github.com/badaix/snapweb/releases/download/v0.6.0/snapweb_0.6.0-1_all.deb\ndpkg -i snapweb_0.6.0-1_all.deb\nsudo apt install snapclient\nmkdir /run/snapserver\nchown _snapserver:audio /run/snapserver\nchmod 0775 /run/snapserver*\nsystemctl restart snapserver\n</code></pre>"},{"location":"multiroom/install/10_install_pi_hifiberry/#fichiers-de-configuration","title":"Fichiers de configuration","text":""},{"location":"multiroom/install/10_install_pi_hifiberry/#creation-du-fichier-etcasoundconf","title":"Cr\u00e9ation du fichier <code>/etc/asound.conf</code>","text":"<p>Ce fichier permet de cr\u00e9er une \"sortie\" audio bleutooth sous forme d'un fichier FIFO.</p> /etc/asound.conf<pre><code>pcm.bluetooth {\n    type plug\n    slave.pcm rate48000Hz\n}\n\npcm.rate48000Hz {\n    type rate\n    slave {\n        pcm writeFile # Direct to the plugin which will write to a file\n        format S16_LE\n        rate 48000\n    }\n}\n\npcm.writeFile {\n    type file\n    slave.pcm null\n    file \"/run/bluefifo\"\n    format \"raw\"\n}\n</code></pre>"},{"location":"multiroom/install/10_install_pi_hifiberry/#mise-a-jour-du-fichier-etcsnapserverconf","title":"Mise \u00e0 jour du fichier <code>/etc/snapserver.conf</code>","text":"<p>Dans se fichier, les sources redirig\u00e9e vers snapserver sont d\u00e9finies dans la section <code>stream</code>. De plus, le chemin racine de l'interface Web de snapserver peut \u00eatre configur\u00e9e.</p> /etc/snapserver.conf<pre><code>[stream]\n...\nsource = pipe:///run/snapserver/mopidyfifo?name=Mopidy\nsource = pipe:///run/bluefifo?name=Bluetooth\n\n[http]\n...\ndoc_root = /usr/share/snapweb\n...\n</code></pre>"},{"location":"multiroom/install/10_install_pi_hifiberry/#installation-mopidy","title":"Installation MOPIDY","text":""},{"location":"multiroom/install/10_install_pi_hifiberry/#installation-du-serveur-mopidy","title":"Installation du serveur Mopidy","text":"<pre><code>sudo mkdir -p /etc/apt/keyrings\nsudo wget -q -O /etc/apt/keyrings/mopidy-archive-keyring.gpg https://apt.mopidy.com/mopidy.gpg\nsudo wget -q -O /etc/apt/sources.list.d/mopidy.list https://apt.mopidy.com/bullseye.list\nsudo apt update\nsudo apt install --no-install-recommends mopidy \nsudo apt install --no-install-recommends python3-pip\nsudo pip install --break-system-packages mopidy-iris\n</code></pre> <p>Warning</p> <p>La documentation du plugin sur Mopidy-Spotify est incorrecte. Il faut aller voir la doc sur Github et forcer l'installation de la version 5.0.0a1 en date du 24/03/2024.</p>"},{"location":"multiroom/install/10_install_pi_hifiberry/#installation-du-plugin-spotify","title":"Installation du plugin Spotify","text":"<pre><code>sudo pip install --break-system-packages Mopidy-Spotify==5.0.0a1\nwget https://github.com/kingosticks/gst-plugins-rs-build/releases/download/gst-plugin-spotify_0.12.2-1/gst-plugin-spotify_0.12.2-1_armhf.deb\nsudo apt install ./gst-plugin-spotify_0.12.2-1_armhf.deb\n</code></pre> <p>Il faut r\u00e9cup\u00e9rer le client id / client secret pour l'utilisation des API Spotify.</p> <p>Warning</p> <p>Il faut un compte Spotify Premium</p> <p>Quelques \u00e9l\u00e9ments restent \u00e0 configurer dans le fichier de configuration Mopidy.</p> /etc/mopidy/mopidy.conf - Ajout des lignes<pre><code>[http]\nhostname = 0.0.0.0\n\n[spotify]\nusername=&lt;username&gt;\npassword=&lt;password&gt;\nclient_id = &lt;clientid&gt;\nclient_secret = &lt;client secret&gt;\n\n[audio]\noutput = audioresample ! audioconvert ! audio/x-raw,rate=48000,channels=2,format=S16LE ! filesink location=/run/snapserver/mopidyfifo\n</code></pre> <p>La section <code>audio</code> permet de d\u00e9finir une nouvelle \"sortie\" audio sous la forme d'un nouveau fichier FIFO qui sera lu par Snapserver</p>"},{"location":"multiroom/install/10_install_pi_hifiberry/#references","title":"R\u00e9f\u00e9rences","text":"<ul> <li>NVM</li> <li>Configuration Hifiberry Linux</li> <li>Redirect A2DP sink</li> <li>fifo permission issues 1</li> <li>fifo permission issues 2</li> </ul>"},{"location":"multiroom/install/20_install_pizero_dacshim/","title":"Configuration Pi Zero avec Audio DAC SHIM","text":""},{"location":"multiroom/install/20_install_pizero_dacshim/#petite-verification-de-la-detection-du-dac","title":"Petite v\u00e9rification de la d\u00e9tection du DAC","text":"<pre><code>pi@multiroom1:~ $ aplay -l\n**** List of PLAYBACK Hardware Devices ****\ncard 0: sndrpihifiberry [snd_rpi_hifiberry_dac], device 0: HifiBerry DAC HiFi pcm5102a-hifi-0 [HifiBerry DAC HiFi pcm5102a-hifi-0]\n  Subdevices: 1/1\n  Subdevice #0: subdevice #0\ncard 1: vc4hdmi [vc4-hdmi], device 0: MAI PCM i2s-hifi-0 [MAI PCM i2s-hifi-0]\n  Subdevices: 1/1\n  Subdevice #0: subdevice #0\n</code></pre>"},{"location":"multiroom/install/20_install_pizero_dacshim/#installation-via-apt-version-026","title":"Installation via apt (version 0.26)","text":"<pre><code>sudo apt install snapclient\n</code></pre>"},{"location":"multiroom/install/90_install_notes/","title":"Notes d'installation","text":""},{"location":"multiroom/install/90_install_notes/#impossible-de-demarrer-la-version-027-sur-debian-bookworms","title":"Impossible de d\u00e9marrer la version 0.27 sur Debian Bookworms","text":"<pre><code>wget https://github.com/badaix/snapcast/releases/download/v0.27.0/snapclient_0.27.0-1_without-pulse_armhf.deb\nwget https://github.com/badaix/snapcast/releases/download/v0.27.0/snapserver_0.27.0-1_armhf.deb\nwget http://ftp.debian.org/debian/pool/main/f/flac/libflac8_1.3.3-2+deb11u2_armhf.deb\nsudo dpkg -i libflac8_1.3.3-2+deb11u2_armhf.deb\nsudo dpkg -i snapserver_0.27.0-1_armhf.deb\napt install\nsudo dpkg -i snapclient_0.27.0-1_without-pulse_armhf.deb\napt install\n</code></pre> <p>Mais impossible de d\u00e9marrer snapclient</p> <p>Unable to install the provided deb package on bookworm-based raspbian</p> <p>Apparement, le prol\u00e8me est r\u00e9solu.</p>"},{"location":"multiroom/install/90_install_notes/#utilisateur-snapcast","title":"Utilisateur Snapcast","text":"<p>Les utilisateurs <code>snapserver</code> et <code>snapclient</code> ont \u00e9t\u00e9 renomm\u00e9s <code>\\_snapserver</code> et <code>\\_snapclient</code> en version 0.16 puis re-renomm\u00e9s en <code>snapserver</code> et <code>snapclient</code> en 0.17. Mais sur la version 0.26 (la 0.27 ne fonctionne pas sur Bookworm), les utilisateurs sont toujours pr\u00e9fix\u00e9s avec <code>_</code>.</p>"}]}